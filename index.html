<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Expense Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        #categoryChart svg {
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body class="bg-light">

    <div class="container mt-5">
        <h2 class="mb-4 text-center">Expense Tracker</h2>

        <!-- Form -->
        <form action="/add" method="POST" class="row g-3 mb-5">
            <div class="col-md-3">
                <input type="number" name="amount" step="0.01" class="form-control" placeholder="Amount" required>
            </div>
            <div class="col-md-3">
                <input type="text" name="category" class="form-control" placeholder="Category" required>
            </div>
            <div class="col-md-3">
                <input type="text" name="note" class="form-control" placeholder="Note (optional)">
            </div>
            <div class="col-md-3">
                <input type="date" name="date" class="form-control">
            </div>
            <div class="col-12 d-grid gap-2 mt-2">
                <button type="submit" class="btn btn-primary">Add Expense</button>
            </div>
        </form>

        <!-- Table -->
        <h4>Recent Expenses</h4>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Note</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense[0] }}</td>
                    <td>${{ '%.2f' | format(expense[1]) }}</td>
                    <td>{{ expense[2] }}</td>
                    <td>{{ expense[3] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Chart -->
        <h4 class="mt-5">Spending by Category</h4>
        <div id="categoryChart"></div>
    </div>

    <script>
        const data = {{ chart_data | safe }};

        const margin = {top: 20, right: 20, bottom: 40, left: 100},
              width = 800 - margin.left - margin.right,
              height = 400 - margin.top - margin.bottom;

        const svg = d3.select("#categoryChart")
                      .append("svg")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                      .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.total)])
                    .range([0, width]);

        const y = d3.scaleBand()
                    .domain(data.map(d => d.category))
                    .range([0, height])
                    .padding(0.1);

        svg.selectAll("rect")
           .data(data)
           .enter()
           .append("rect")
           .attr("x", 0)
           .attr("y", d => y(d.category))
           .attr("width", d => x(d.total))
           .attr("height", y.bandwidth())
           .attr("fill", "#007bff");

        svg.append("g")
           .call(d3.axisLeft(y));

        svg.append("g")
           .attr("transform", `translate(0, ${height})`)
           .call(d3.axisBottom(x));
    </script>
</body>
</html>